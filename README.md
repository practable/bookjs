# bookjs

Javascript client for booking experiments from [practable/book](https://github.com/practable/book).

## Status

In development.

##

API services

## Design ideas


Could use [v-model binding to componen](https://vuejs.org/guide/components/v-model.html) with getter setter funcs, to allow the sub-components to update the main state??


Using xstate to manage global state with [useSelector](https://stately.ai/blog/how-to-manage-global-state-with-xstate-and-react)

We can assess global state and send by using useActor, e.g. [here](https://garden.bradwoods.io/notes/javascript/state-management/xstate/global-state()


Rather than routing, we could use hidden [tabs and KeepAlive](https://vuejs.org/guide/essentials/component-basics.html#dynamic-components)

Async components could replace some of the state?! [example](https://vuejs.org/guide/components/async.html#loading-and-error-states)



## Testing


vitest

```
npm install -D vitest
npm install --save-dev @vue/test-utils
```

add to `package.json` scripts list:

```
    "test:unit": "vitest run --environment jsdom"
```

Checking the [typescript settings](https://stackoverflow.com/questions/71215876/must-use-import-to-load-es-module-node-modules-got-dist-source-index-js)

the answer says update typescript, and node (both badly out of date, e.g. node was at 12, latest is 19.6.0)

And that fixed it.

Also install jsdom
```
npm install -D jsdom
```

[mock localstorage](https://www.npmjs.com/package/vitest-localstorage-mock)

```
npm install -D vitest-localstorage-mock
```

Edit vite.config.js as per install info at link

### local storage mocking

consider [this](https://www.npmjs.com/package/vitest-localstorage-mock)

Or do [this fix](https://stackoverflow.com/questions/54922579/vue-js-unit-test-localstorage-is-not-defined) to use actual local storage.

## Features


typical use case - prebooked session, and access for limited window.

How do we share that with a user? we can set sessionIDs and policies as URL params, e.g. 


`https://uoe.practable.io/book/?sid=some_session_id&pid=some_policy_id`

- user cannot cancel sessionID bookings, because they might be shared in a group.


If that link is too clunky, we can always shorten it with a link shortener (e.g. using bitly or the university of edinburgh link shortener)

If we need to send multiples then we can do arrays .... need to check formatting. Some examples [here](https://forum.vuejs.org/t/vue-router-parameter-as-an-array/7754/2) and [here](https://stackoverflow.com/questions/50692081/vue-js-router-query-array).

but maybe ..
 

We can treat a one-off session as a user, if we book the session under a unique user name, e.g. a descriptive name including the date (`soe-engdes1-23-feb-17-tues-1400-1500-spinner-00`. Even though the system treats it as a user, we have the UI request this as a code to be typed in for a "session" and it gets all the bookings for that user as well. This user can be added to the localstorage to provide persistance if the machine is rebooted. Which identity does david use for the analytics?

We can have a single primary userID, to be used for analytics, and multiple "sessions". Users should be able to change their primary userID. The primary userID is what their bookings are made against.

All users are anonymous at present. There are persistent and epheremal user ids, so we can support staff pre-booking activities for students.

For example, hand out airport-style quick-reference codes which refer to a token containing a username and booking id code for a booking to borrow.

The booking is accessed as that user, but the persistent identity of the user remains intact for use with analytics.

Each instance has its own unique anonymous identity, generated by the book server.

You can change to another anonymous identity, e.g. to share the same account across multiple devices.

You can borrow a booking by entering a user-name and bookingID (can you do this in advance, or only at the time?)

Analytics server would still pick up the anonymous identity of the user


Allow users to change their user name, to transfer from another device.
limit user names to the number of characters, letters and numbers that we expect from xid.
show green or red depending on whether the format is met.
run [bad words filter](https://www.npmjs.com/package/bad-words)
Keep a history of user names so users can revert (e.g. if they make a mistake, and have bookings)

Allow users to put in an short code that retrieves user/booking combo from another server.
An endpoint for this would be useful .... publish shortcodes on page so anyone can copy? put behind a button so shoulder surfing cannot be used to steal a booking?

Booking has to be set to shareable for this to work? I.e. students can protect their own bookings from being shared?
Would need an endpoint for making the booking shareable or unsharable. What if it is made unsharable after being shared? The short code no longer works, and is not re-used... need to keep a list of stale short codes....

could use words for ease, but wordlists like '/usr/share/dict/words' have offensive words.
[scowl](https://github.com/en-wl/wordlist) lists some words as offensive, but not nearly enough.

filtering with [bad words list](https://github.com/LDNOOBW/List-of-Dirty-Naughty-Obscene-and-Otherwise-Bad-Words) [discussed here](https://github.com/dwyl/english-words/issues/95) but this is incomplete.

[EFF did this already](https://www.eff.org/deeplinks/2016/07/new-wordlists-random-passphrases) although it still has some words I wouldn't want to see in a phrase given to students.





## Notes from previous version - remove on or about first release

## Deployment / Local testing

We use the Vue CLI, and treat the app as static because it can access the API of the backend via normal HTTP verbs. This means we can install it by copying the `dist` directory directly onto the server). 

### Deployment

We use `npm` to build for production:

```
cd <repo-path>/src
npm run build
```

### Testing

Script added to package.json to run build with development mode

```
npm run build-dev
```

However, with we can't just run it locally for testing, because the public path setting would be wrong if we access it from `file://<your-path>` so we can [serve it locally by installing serve](https://cli.vuejs.org/guide/deployment.html) 

```
npm install -g serve
```
Then to serve locally, just run
```
serve -s dist
```

You'll see a terminal message something like this, and the app will be able to access the production booking server for which it is configured.

```
   ┌──────────────────────────────────────────────────┐
   │                                                  │
   │   Serving!                                       │
   │                                                  │
   │   - Local:            http://localhost:5000      │
   │   - On Your Network:  http://192.168.0.46:5000   │
   │                                                  │
   │   Copied local address to clipboard!             │
   │                                                  │
   └──────────────────────────────────────────────────┘
```

Note you have to be in `src` or else you get path not found error in the browser.

You will want a book server running on localhost:4000 
You will want to serve tokens on a localhost:4001
You will want to try insecure chrome

These options are all supported in `test/scripts/test_serve.sh`

Note - the suggested order of commands when using the `test_serve` script is

  - `g` - start insecure chrome
  - `u` - upload manifest
  - `t` - start serving the token

If you are using an alternative means of providing the booking server and token, then you can start insecure chrome like this:

```
mkdir -p ~/tmp/chrome-user
google-chrome --disable-web-security --user-data-dir="~/tmp/chrome-user" > chrome.log 2>&1 &	
```

## Dev notes

### Book update to config
`sessions?duration=300`:
```
{
   "description":{
      "further":"https://static.practable.io/info/pvna-real-1.0/index.html",
      "id":"0dbd1ba8-82cd-4d24-a304-2fcc935d058e",
      "image":"https://assets.practable.io/images/booking/activities/pvna-real-1.0/image.png",
      "long":"A pocketVNA Vector Network Analyser that can read two-port S-parameters",
      "name":"PocketVNA",
      "short":"A pocketVNA Vector Network Analyser",
      "thumb":"https://assets.practable.io/images/booking/activities/pvna-real-1.0/thumb.png",
      "type":"pvna-activity-v1.0"
   },
   "exp":1644359390,
   "streams":[
      {
         "for":"data",
         "permission":{
            "audience":"https://relay-access.practable.io",
            "connection_type":"session",
            "scopes":[
               "read",
               "write"
            ],
            "topic":"pvna01-data"
         },
         "token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b3BpYyI6InB2bmEwMS1kYXRhIiwicHJlZml4Ijoic2Vzc2lvbiIsInNjb3BlcyI6WyJyZWFkIiwid3JpdGUiXSwiYXVkIjoiaHR0cHM6Ly9yZWxheS1hY2Nlc3MucHJhY3RhYmxlLmlvIiwiZXhwIjoxNjQ0MzU5MzkwLCJpYXQiOjE2NDQzNTkwODksIm5iZiI6MTY0NDM1OTA4OX0.zuopsXnmkjn777KR3kLt0C2cwo2sNJdVZb0kR5A0ot0",
         "url":"https://relay-access.practable.io/session/pvna01-data",
         "verb":"POST"
      }
   ],
   "uis":[
      {
         "description":{
            "further":"https://static.practable.io/info/pvna-basic-ui-1.0/index.html",
            "image":"https://assets.practable.io/images/booking/ui/pvna-default-1.0/image.png",
            "long":"Read S-parameters from pocketVNA, and plot them as a function of frequency",
            "name":"PocketVNA (Default)",
            "short":"Read S-parameters from pocketVNA",
            "thumb":"https://assets.practable.io/images/booking/ui/pvna-default-1.0/thumb.png",
            "type":"pvna-default-ui-1.0"
         },
         "streamsRequired":[
            "data"
         ],
         "url":"https://static.practable.io/ui/pvna-1.0/?config={{config}}&streams={{streams}}&exp={{exp}}"
      },
      {
         "description":{
            "further":"https://static.practable.io/info/debug-ui-1.0/index.html",
            "image":"https://assets.practable.io/images/booking/ui/debug-1.0/image.png",
            "long":"See the video, data, and type commands.",
            "name":"Debug",
            "short":"See the video, data, and type commands.",
            "thumb":"https://assets.practable.io/images/booking/ui/debug-1.0/thumb.png",
            "type":"debug-ui-1.0"
         },
         "streamsRequired":[
            "data",
            "video"
         ],
         "url":"https://static.practable.io/ui/debug-1.0/?streams={{streams}}&exp={{exp}}"
      },
      {
         "description":{
            "further":"https://static.practable.io/info/debug-ui-1.0/index.html",
            "image":"https://assets.practable.io/images/booking/ui/debug-1.0/image.png",
            "long":"See the video, data, and type commands.",
            "name":"Debug (Develop)",
            "short":"See the video, data, and type commands.",
            "thumb":"https://assets.practable.io/images/booking/ui/debug-1.0/thumb.png",
            "type":"dev-debug-ui-1.0"
         },
         "streamsRequired":[
            "data",
            "video"
         ],
         "url":"https://dev-static.practable.io/ui/debug-1.0/?streams={{streams}}&exp={{exp}}"
      },
      {
         "description":{
            "further":"https://static.practable.io/info/pvna-basic-ui-1.0/index.html",
            "image":"https://assets.practable.io/images/booking/ui/pvna-default-1.0/image.png",
            "long":"Read S-parameters from pocketVNA, and plot them as a function of frequency",
            "name":"PocketVNA (Develop)",
            "short":"Read S-parameters from pocketVNA",
            "thumb":"https://assets.practable.io/images/booking/ui/pvna-default-1.0/thumb.png",
            "type":"dev-pvna-ui-1.0"
         },
         "streamsRequired":[
            "data"
         ],
         "url":"https://dev-static.practable.io/ui/pvna-1.0/?config={{config}}&streams={{streams}}&exp={{exp}}"
      }
   ]
}
```

After the update to include config:

```
{
   "config":{
      "url":""
   },
   "description":{
      "further":"https://static.practable.io/info/pvna-real-1.0/index.html",
      "id":"8276d7aa-4916-4676-80f0-6fa3c7e48e65",
      "image":"https://assets.practable.io/images/booking/activities/pvna-real-1.0/image.png",
      "long":"A pocketVNA Vector Network Analyser that can read two-port S-parameters",
      "name":"PocketVNA",
      "short":"A pocketVNA Vector Network Analyser",
      "thumb":"https://assets.practable.io/images/booking/activities/pvna-real-1.0/thumb.png",
      "type":"pvna-activity-v1.0"
   },
   "exp":1644359606,
   "streams":[
      {
         "for":"data",
         "permission":{
            "audience":"https://relay-access.practable.io",
            "connection_type":"session",
            "scopes":[
               "read",
               "write"
            ],
            "topic":"pvna01-data"
         },
         "token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b3BpYyI6InB2bmEwMS1kYXRhIiwicHJlZml4Ijoic2Vzc2lvbiIsInNjb3BlcyI6WyJyZWFkIiwid3JpdGUiXSwiYXVkIjoiaHR0cHM6Ly9yZWxheS1hY2Nlc3MucHJhY3RhYmxlLmlvIiwiZXhwIjoxNjQ0MzU5NjA2LCJpYXQiOjE2NDQzNTkzMDUsIm5iZiI6MTY0NDM1OTMwNX0.diXof26QFBWSUQuyG-vtnGCgTAmN8DzSwzBijuU2PR0",
         "url":"https://relay-access.practable.io/session/pvna01-data",
         "verb":"POST"
      }
   ],
   "uis":[
      {
         "description":{
            "further":"https://static.practable.io/info/pvna-basic-ui-1.0/index.html",
            "image":"https://assets.practable.io/images/booking/ui/pvna-default-1.0/image.png",
            "long":"Read S-parameters from pocketVNA, and plot them as a function of frequency",
            "name":"PocketVNA (Default)",
            "short":"Read S-parameters from pocketVNA",
            "thumb":"https://assets.practable.io/images/booking/ui/pvna-default-1.0/thumb.png",
            "type":"pvna-default-ui-1.0"
         },
         "streamsRequired":[
            "data"
         ],
         "url":"https://static.practable.io/ui/pvna-1.0/?config={{config}}&streams={{streams}}&exp={{exp}}"
      },
      {
         "description":{
            "further":"https://static.practable.io/info/debug-ui-1.0/index.html",
            "image":"https://assets.practable.io/images/booking/ui/debug-1.0/image.png",
            "long":"See the video, data, and type commands.",
            "name":"Debug",
            "short":"See the video, data, and type commands.",
            "thumb":"https://assets.practable.io/images/booking/ui/debug-1.0/thumb.png",
            "type":"debug-ui-1.0"
         },
         "streamsRequired":[
            "data",
            "video"
         ],
         "url":"https://static.practable.io/ui/debug-1.0/?streams={{streams}}&exp={{exp}}"
      },
      {
         "description":{
            "further":"https://static.practable.io/info/debug-ui-1.0/index.html",
            "image":"https://assets.practable.io/images/booking/ui/debug-1.0/image.png",
            "long":"See the video, data, and type commands.",
            "name":"Debug (Develop)",
            "short":"See the video, data, and type commands.",
            "thumb":"https://assets.practable.io/images/booking/ui/debug-1.0/thumb.png",
            "type":"dev-debug-ui-1.0"
         },
         "streamsRequired":[
            "data",
            "video"
         ],
         "url":"https://dev-static.practable.io/ui/debug-1.0/?streams={{streams}}&exp={{exp}}"
      },
      {
         "description":{
            "further":"https://static.practable.io/info/pvna-basic-ui-1.0/index.html",
            "image":"https://assets.practable.io/images/booking/ui/pvna-default-1.0/image.png",
            "long":"Read S-parameters from pocketVNA, and plot them as a function of frequency",
            "name":"PocketVNA (Develop)",
            "short":"Read S-parameters from pocketVNA",
            "thumb":"https://assets.practable.io/images/booking/ui/pvna-default-1.0/thumb.png",
            "type":"dev-pvna-ui-1.0"
         },
         "streamsRequired":[
            "data"
         ],
         "url":"https://dev-static.practable.io/ui/pvna-1.0/?config={{config}}&streams={{streams}}&exp={{exp}}"
      }
   ]
}

```

### modal promise pattern

description [here](https://dev.to/danitrap/vue-3-expressive-api-for-confirmation-modals-3757)
Needs type script installing

### CORS localhost
[use cmd line opts to disable CORS](https://stackoverflow.com/questions/3102819/disable-same-origin-policy-in-chrome)
`google-chrome --disable-web-security --user-data-dir="[some directory here]"`

### Axios

[Use in components](https://codesandbox.io/s/vue-axios-http-get-request-examples-ei7l8?file=/app/GetRequest.vue:0-529)

`npm install axios`


```
<template>
  <div class="card text-center m-3">
    <h5 class="card-header">Simple GET Request</h5>
    <div class="card-body">Total vue packages: {{totalVuePackages}}</div>
  </div>
</template>

<script>
import axios from 'axios';

export default {
  name: "get-request",
  data() {
    return {
      totalVuePackages: null
    };
  },
  created() {
    // Simple GET request using axios
    axios.get("https://api.npms.io/v2/search?q=vue")
      .then(response => this.totalVuePackages = response.data.total);
  }
};
</script>


```

### Scopes

There are four scopes
https://michaelnthiessen.com/levels-of-vue-scope

And the scope of this depends on how the function was invoked
https://www.jackfranklin.co.uk/blog/javascript-variable-scope-this/

### chrome dev tools

you need the [beta version](https://chrome.google.com/webstore/detail/vuejs-devtools/ljjemllljcmogpfapbkkighbhhppjdbg?hl=en) for vue3 to work in chrome

### configuring

to [get full build in vue-cli](https://github.com/vuejs/vue-cli/issues/1040) you need a [`vue.config.js`](https://www.digitalocean.com/community/tutorials/vuejs-using-new-vue-cli-3#the-vueconfigjs-file)

make new vue.config.js in root

```
module.exports = {
  lintOnSave: true,
  runtimeCompiler: true,
};
```

### Use

Plugins are added by 'use' which can be called more than once, but [only installs each plugin once](https://vuejs.org/v2/guide/plugins.html), and must be used in commonJS pattern

### Aggregating exports

[Pattern: use almost-empty parent module to aggregate exports for a single module](https://developer.mozilla.org/en-US/docs/web/javascript/reference/statements/export#using_the_default_export)

```
// In childModule1.js
let myFunction = ...; // assign something useful to myFunction
let myVariable = ...; // assign something useful to myVariable
export {myFunction, myVariable};
```

```
// In childModule2.js
let myClass = ...; // assign something useful to myClass
export myClass;
```

```
// In parentModule.js
// Only aggregating the exports from childModule1 and childModule2
// to re-export them
export { myFunction, myVariable } from 'childModule1.js';
export { myClass } from 'childModule2.js';
```

```
// In top-level module
// We can consume the exports from a single module since parentModule
// "collected"/"bundled" them in a single source
import { myFunction, myVariable, myClass } from 'parentModule.js'
```

### Vuex

Latest version on 4 branch is rc.2

`npm i -S vuex@4.0.0-rc.2 `

### Importing external js for use in multiple components

Importing external js can be done several naiive ways, or [like this](https://vuejsdevelopers.com/2017/04/22/vue-js-libraries-plugins/)

```
//entry.js
import moment from 'moment';
Object.defineProperty(Vue.prototype, '$moment', { value: moment });
```

```
// mynewcomponent.vue
export default {
  created() {
    console.log('The time is ' . this.$moment().format("HH:mm"));
  }
}
```

Makes it write only so you can assign somethign else to the property and break thigns

## moving to vite

[migration guide](https://vueschool.io/articles/vuejs-tutorials/how-to-migrate-from-vue-cli-to-vite/)

then 

```
npm install -g vite
```

then `npm run dev`

```
<snip>
import { performance } from 'node:perf_hooks'
       ^

SyntaxError: Unexpected token {
<snip>
```
Looks like this [perf hooks issue]( https://stackoverflow.com/questions/63383304/unable-to-resolve-module-perf-hooks), solution proposed is
```
 npm i --save-dev @types/node

```
and that fixed it.

Except that could not find global css or main.js￼

```
localhost/:8 
 GET http://localhost:3000/global.css net::ERR_ABORTED 404 (Not Found)
localhost/:10 
 GET http://localhost:3000/src/main.js net::ERR_ABORTED 404 (Not Found)
client.ts:16 [vite] connecting...
client.ts:53 [vite] connected.
```

oops ... `main.js` is now `main.ts`!

fix ... but then repeated reloads with errors, similar to [this bad gateway for deps](https://github.com/vitejs/vite/discussions/8749)

```
<snip>
[vite] error while updating dependencies:
Error: ENOTEMPTY: directory not empty, rmdir '/home/tim/sources/bookjs/src/node_modules/.vite/deps'
<snip>
```

asdfasdf


```
rm -r 
```

Also, env vars need changing to prefix `VITE` []()

> To prevent accidentally leaking env variables to the client, only variables prefixed with VITE_ are exposed to your Vite-processed code. e.g. for the following env variables:

```
VITE_SOME_KEY=123
DB_PASSWORD=foobar 

```
> Only `VITE_SOME_KEY` will be exposed as `import.meta.env.VITE_SOME_KEY` to your client source code, but `DB_PASSWORD` will not.

changed all `VUE_APP` to `VITE_APP`, and now running fine locally on `npm run dev` with development env.vars pointing to the existing AWS server instantiation (for convenience in avoiding setting up local services).


Now try production build with base path and host on `dev.practable.io/book` ...

```
npm run build
```

Still got the base_path problem with css and js assets, being looked for at `https://dev.practable.io/css/<name>` and  `https://dev.practable.io/js/<name>` so page is not loading, and can't check whether the routing etc is working yet.


[base path for local dev](https://github.com/vitejs/vite/issues/3107) server origin, base href

added base href, did not fix issue...

[not sure about this router config as seems different, but apparently works](https://github.com/antfu/vitesse/discussions/226)


### Font Awesome

[icon colour changes](https://stackoverflow.com/questions/14474452/can-i-change-the-color-of-font-awesomes-cog-icon)

for all icons in project put this in css
```
.fa {
  color : red;
}
```


### XState

#### Logging in

```
stateDiagram-v2
    [*] --> UserNameFromStorage 
    UserNameFromStorage --> LoginTokenFetch : OK
    UserNameFromStorage --> UserNameFetch : Error
    UserNameFetch --> UserNameAwaitResponse
    UserNameAwaitResponse --> UserNameStore : OK
    UserNameStore --> LoginTokenFetch
    UserNameAwaitResponse --> UserNameWaitBackOff : Error
    UserNameWaitBackOff --> UserNameFetch
    LoginTokenFetch --> LoginTokenAwaitResponse
    LoginTokenAwaitResponse --> StoreLoginToken : OK
    LoginTokenAwaitResponse --> LoginTokenWaitBackOff : Error
    LoginTokenWaitBackOff --> LoginTokenFetch
    StoreLoginToken --> RefreshAwait 
    RefreshAwait --> LoginTokenFetch : RefreshRequested
    RefreshAwait --> UserNameFromStorage : UserNameChanged
```

#### Showing kit and taking bookings

```
stateDiagram-v2
    [*] --> RefreshLoginToken
    GetGroups --> GetBookings
    RefreshLoginToken --> GetGroups 
    GetBookings --> Wait
    Wait --> RefreshLoginToken : RefreshRequested
    Wait --> GetGroupDetails : GroupSelected
    GetGroupDetails --> GetPolicies
    GetPolicies -->  Wait
    Wait --> GetSlots : PolicySelected
    GetSlots --> DisplaySuggestedBookingTimes
    DisplaySuggestedBookingTimes --> Wait
    Wait --> MakeBooking : TimeSelected
    MakeBooking --> GetBookings : OK
    Wait --> StartBooking : ClickOpen
    StartBooking --> Wait
    Wait --> CancelBooking : ClickCancel
    CancelBooking --> GetBookings
```

```
stateDiagram-v2
    [*] --> RefreshLoginToken
    GetGroups --> Wait
    RefreshLoginToken --> GetGroupsAndBookings
    GetGroupsAndBookings --> Wait
    GetBookings --> Wait
    Wait --> RefreshLoginToken : RefreshRequested
    Wait --> CheckGroupDetails : GroupSelected
    CheckGroupDetails --> GetGroupDetails : Stale
    CheckGroupDetails --> CheckSlotAvailabilities: Fresh
    CheckSlotAvailabilities --> GetSlotAvailabilities : Stale
    CheckSlotAvailabilities  --> DisplaySuggestedBookingTimes : Fresh
    GetGroupDetails --> GetPolicies
    GetPolicies -->  GetSlotAvailabilities
    GetSlotAvailabilities--> CalculateSuggestedBookingTimes
    CalculateSuggestedBookingTimes --> DisplaySuggestedBookingTimes
    DisplaySuggestedBookingTimes --> Wait
    Wait --> MakeBooking : TimeSelected
    MakeBooking --> GetBookings : OK
    Wait --> StartBooking : ClickOpen
    StartBooking --> Wait
    Wait --> CancelBooking : ClickCancel
    CancelBooking --> GetBookings
    Wait --> AddGroup
    AddGroup --> GetGroups  
    Wait --> GetSlotAvailabilities : UserRequestedRefresh

```

```
 stateDiagram-v2
    [*] --> RefreshLoginToken
    GetGroups --> Wait
    RefreshLoginToken --> GetGroupsAndBookings
    GetGroupsAndBookings --> Wait
    GetBookings --> Wait
    Wait --> RefreshLoginToken : ForceRefreshLogin
    Wait --> GetBookings : ForceRefreshBookings
    Wait --> CheckGroupDetails : GroupSelected
    CheckGroupDetails --> GetGroupDetails : Stale
    CheckGroupDetails --> CheckSlotAvailabilities: Fresh
    CheckSlotAvailabilities --> GetSlotAvailabilities : Stale
    CheckSlotAvailabilities  --> Wait: Fresh
    GetGroupDetails --> GetPolicies
    GetPolicies -->  GetSlotAvailabilities
    GetSlotAvailabilities--> GetIndividualSlotAvailability
    GetIndividualSlotAvailability --> CalculateSuggestedBookingTimes
    CalculateSuggestedBookingTimes --> GetIndividualSlotAvailability : NextSlot
    CalculateSuggestedBookingTimes --> Wait : Done
    Wait --> MakeBooking : TimeSelected
    MakeBooking --> GetBookings : OK
    Wait --> StartBooking : ClickOpen
    StartBooking --> Wait
    Wait --> CancelBooking : ClickCancel
    CancelBooking --> GetBookings
    Wait --> AddGroup
    AddGroup --> GetGroups  
    Wait --> GetGroupDetails : ForceRefreshGroupDetails
    Wait --> GetIndividualSlotAvailability : ForceRefreshOneSlot
    Wait --> GetSlotAvailabilities : ForceRefreshAll
```


RefreshMachine

```
stateDiagram-v2
    [*] --> AwaitToken
    AwaitToken --> Fetch : TokenRefreshed
    Fetch --> Fresh : OK
    Fetch --> AwaitToken : Unauthorised
    Fetch --> Backoff : Error
    Backoff --> Fetch : Timeout
    Fresh --> Stale : Timeout
    Fresh --> Fresh : Refresh (NOOP)
    Stale --> Fetch : Refresh

```

KindRefreshMachine
```
stateDiagram-v2
    [*] --> AwaitToken
    AwaitToken --> Fetch : TokenRefreshed
    Fetch --> Fresh : OK
    Fetch --> AwaitToken : Unauthorised
    Fetch --> Backoff : Error
    Backoff --> Fetch : Timeout
    Fresh --> Stale : Timeout
    Fresh --> Fresh : KindRefresh (NOOP)
    Stale --> Fetch : KindRefresh, ForceRefresh
    Fresh --> Fetch : ForceRefresh
	```
